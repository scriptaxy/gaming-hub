name: Build iOS App

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-latest
    env:
      DOTNET_NOLOGO: true
      DOTNET_CLI_TELEMETRY_OPTOUT: true
      DOTNET_ROOT: /Users/runner/.dotnet-custom
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Clean install .NET 8 SDK
        run: |
          # Download and install .NET 8 to custom location
          curl -sSL https://dot.net/v1/dotnet-install.sh -o dotnet-install.sh
          chmod +x dotnet-install.sh
          ./dotnet-install.sh --channel 8.0 --install-dir $DOTNET_ROOT
          echo "$DOTNET_ROOT" >> $GITHUB_PATH

      - name: Verify .NET version
        run: |
          $DOTNET_ROOT/dotnet --version
          $DOTNET_ROOT/dotnet --list-sdks

      - name: Show Xcode version
        run: xcodebuild -version

      - name: Install iOS Workload
        run: $DOTNET_ROOT/dotnet workload install ios --skip-sign-check

      - name: Update project to .NET 8
        run: |
          sed -i '' 's/net9.0-ios/net8.0-ios/g' "gaming hub/gaming hub.csproj"
          cat "gaming hub/gaming hub.csproj"

      - name: Restore NuGet packages
        run: $DOTNET_ROOT/dotnet restore "gaming hub/gaming hub.csproj"

      - name: Build for iOS Device (unsigned)
        run: |
          $DOTNET_ROOT/dotnet build "gaming hub/gaming hub.csproj" \
            -c Release \
            -f net8.0-ios \
            -r ios-arm64 \
            -p:CodesignKey="-" \
            -p:CodesignProvision="" \
            -p:CodesignEntitlements="" \
            -p:_RequireCodeSigning=false \
            --no-restore

      - name: Create IPA file
        run: |
          APP_PATH=$(find "gaming hub/bin/Release" -name "*.app" -type d | head -1)
          echo "Found app at: $APP_PATH"
    
          if [ -z "$APP_PATH" ]; then
            echo "No .app found, listing directory:"
            find "gaming hub/bin" -type d -name "*.app"
            exit 1
          fi
          
          # Create Payload directory structure
          mkdir -p Payload
          cp -r "$APP_PATH" Payload/
       
          # Create IPA (just a zip with .ipa extension)
          zip -r "GamingHub.ipa" Payload
          
          # Verify IPA was created
          ls -la GamingHub.ipa
          
          # Clean up
          rm -rf Payload

      - name: List build outputs
        run: |
          echo "=== IPA File ==="
          ls -la *.ipa 2>/dev/null || echo "No IPA found"
          echo ""
          echo "=== App Bundles ==="
          find "gaming hub/bin" -name "*.app" -type d 2>/dev/null || echo "No .app found"

      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: GamingHub-iOS
          path: GamingHub.ipa
          retention-days: 14
          if-no-files-found: error

      - name: Upload App Bundle (backup)
        uses: actions/upload-artifact@v4
        with:
          name: ios-app-bundle
          path: "gaming hub/bin/Release/net8.0-ios/ios-arm64/"
          retention-days: 14
          if-no-files-found: warn
