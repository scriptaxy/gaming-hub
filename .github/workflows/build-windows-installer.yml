name: Build Windows Installer

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number'
        required: true
        default: '1.0.0'

env:
  DOTNET_VERSION: '9.0.x'

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 9.0.x
      
      - run: dotnet restore SynktraCompanion/SynktraCompanion.csproj
      
      - run: dotnet build SynktraCompanion/SynktraCompanion.csproj -c Release --no-restore
      
      - run: dotnet publish SynktraCompanion/SynktraCompanion.csproj -c Release -r win-x64 --self-contained true -o SynktraCompanion/bin/Release/net9.0-windows/win-x64/publish
      
      - name: Download ViGEmBus
        shell: bash
        run: |
          mkdir -p SynktraCompanion/Installer/Dependencies
          curl -L -o SynktraCompanion/Installer/Dependencies/ViGEmBus_Setup.exe https://github.com/nefarius/ViGEmBus/releases/download/v1.22.0/ViGEmBus_1.22.0_x64_x86_arm64.exe
      
      - name: Install Inno Setup
        shell: cmd
        run: choco install innosetup -y
      
      - name: Build Installer
        shell: cmd
        run: '"C:\Program Files (x86)\Inno Setup 6\ISCC.exe" SynktraCompanion\Installer\SynktraCompanion.iss'
  
      - uses: actions/upload-artifact@v4
        with:
          name: SynktraCompanion-Installer
          path: SynktraCompanion/Installer/Output/*.exe
      
      - name: Create Portable ZIP
        shell: pwsh
        run: |
          Compress-Archive -Path "SynktraCompanion/bin/Release/net9.0-windows/win-x64/publish/*" -DestinationPath "SynktraCompanion-Portable-win-x64.zip"
      
      - uses: actions/upload-artifact@v4
        with:
          name: SynktraCompanion-Portable
          path: SynktraCompanion-Portable-win-x64.zip

      - name: Get version
        id: version
        shell: bash
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ startsWith(github.ref, 'refs/tags/') && github.ref_name || format('v{0}', steps.version.outputs.version) }}
          name: Synktra Companion v${{ steps.version.outputs.version }}
          draft: false
          prerelease: false
          files: |
            SynktraCompanion/Installer/Output/*.exe
            SynktraCompanion-Portable-win-x64.zip
          body: |
            ## Synktra Companion v${{ steps.version.outputs.version }}
            
            Desktop companion app for Gaming Hub - stream your PC games to your iPhone.
                    
            ### Features
              - ?? Virtual Xbox 360 controller support (ViGEmBus)
              - ?? Low-latency video streaming (WebSocket + UDP)
              - ?? Audio streaming support
              - ?? GPU priority optimization for gaming
              - ?? Auto-discovery on local network
              - ?? Game library scanning (Steam, Epic, GOG, Xbox)
              
            ### Downloads
              - **SynktraCompanion-Setup.exe** - Full installer with ViGEmBus driver
              - **SynktraCompanion-Portable-win-x64.zip** - Portable version (no installation)
                  
                  ### Requirements
                  - Windows 10/11 (64-bit)
                  - .NET 9 Runtime (bundled in installer)
                  - ViGEmBus driver (optional, for virtual controller)
                  
                  ### Ports Used
                  | Port   | Protocol | Description       |
                  |--------|----------|-------------------|
                  | 19500  | TCP      | REST API          |
                  | 19501  | TCP      | Video WebSocket    |
                  | 19502  | UDP      | Video UDP         |
                  | 19503  | TCP      | Audio WebSocket    |
                  | 5001   | UDP      | Discovery         |
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
